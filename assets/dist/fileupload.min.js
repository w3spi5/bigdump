(function(){"use strict";var C=document.getElementById("fileUpload");if(!C)return;var y=document.getElementById("bigdump-config"),x=!1;y&&y.dataset.bz2Supported!==void 0&&(x=y.dataset.bz2Supported==="true");var w=["sql","gz"];x&&w.push("bz2"),w.push("csv");var d={maxFileSize:parseInt(C.dataset.maxFileSize,10)||0,maxConcurrent:2,allowedTypes:w,uploadUrl:C.dataset.uploadUrl||"",bz2Supported:x},r={files:new Map,uploading:0,queue:[]},m=document.getElementById("dropzone"),B=document.getElementById("fileInput"),L=document.getElementById("fileList"),A=document.getElementById("uploadActions"),F=document.getElementById("uploadBtn"),k=document.getElementById("clearBtn");function I(t){if(t===0)return"0 B";var e=1024,a=["B","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+a[n]}function N(t){return t.split(".").pop().toLowerCase()}function T(){return"file_"+Math.random().toString(36).substr(2,9)}function h(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("viewBox","0 0 24 24");var a=document.createElementNS("http://www.w3.org/2000/svg","path");return t==="success"?(e.setAttribute("fill","#38a169"),a.setAttribute("d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")):t==="error"?(e.setAttribute("fill","#e53e3e"),a.setAttribute("d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")):t==="remove"&&(a.setAttribute("d","M6 18L18 6M6 6l12 12"),a.setAttribute("stroke","currentColor"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round")),e.appendChild(a),e}function D(t){var e=N(t.name);return e==="bz2"&&!d.bz2Supported?{valid:!1,error:"BZ2 files require the PHP bz2 extension which is not installed on the server"}:d.allowedTypes.indexOf(e)===-1?{valid:!1,error:"Invalid file type. Allowed: "+d.allowedTypes.join(", ")}:t.size>d.maxFileSize?{valid:!1,error:"File too large. Max: "+I(d.maxFileSize)}:t.size===0?{valid:!1,error:"File is empty"}:{valid:!0}}function U(t,e,a){var n=N(e.name),s=a.valid,i=document.createElement("div");i.className="file-upload__item"+(s?"":" file-upload__item--error"),i.id=t;var v=document.createElement("div");v.className="file-upload__item-icon file-upload__item-icon--"+n,v.textContent=n,i.appendChild(v);var l=document.createElement("div");l.className="file-upload__item-info";var g=document.createElement("div");g.className="file-upload__item-name",g.textContent=e.name,l.appendChild(g);var u=document.createElement("div");if(u.className="file-upload__item-meta",u.textContent=I(e.size),!s){var p=document.createElement("span");p.className="file-upload__error",p.textContent=" \u2014 "+a.error,u.appendChild(p)}l.appendChild(u),i.appendChild(l);var o=document.createElement("div");o.className="file-upload__item-progress",o.style.display="none";var c=document.createElement("div");c.className="file-upload__progress-bar";var f=document.createElement("div");f.className="file-upload__progress-fill",f.style.width="0%",c.appendChild(f),o.appendChild(c);var z=document.createElement("div");z.className="file-upload__progress-text",z.textContent="0%",o.appendChild(z),i.appendChild(o);var M=document.createElement("div");M.className="file-upload__item-status",i.appendChild(M);var _=document.createElement("button");return _.type="button",_.className="file-upload__item-remove",_.dataset.id=t,_.appendChild(h("remove")),i.appendChild(_),i}function S(t){for(var e=0;e<t.length;e++){var a=t[e],n=T(),s=D(a);r.files.set(n,{file:a,status:s.valid?"pending":"invalid",progress:0,validation:s});var i=U(n,a,s);L.appendChild(i)}E()}function P(t){var e=document.getElementById(t);e&&e.remove(),r.files.delete(t),E()}function E(){var t=!1;r.files.forEach(function(e){e.status==="pending"&&(t=!0)}),A.style.display=r.files.size>0?"flex":"none",F.disabled=!t||r.uploading>0}function O(t){var e=r.files.get(t);return!e||e.status!=="pending"?Promise.resolve():new Promise(function(a){var n=document.getElementById(t),s=n.querySelector(".file-upload__item-progress"),i=n.querySelector(".file-upload__progress-fill"),v=n.querySelector(".file-upload__progress-text"),l=n.querySelector(".file-upload__item-status"),g=n.querySelector(".file-upload__item-remove");n.classList.add("file-upload__item--uploading"),s.style.display="block",g.style.display="none",l.textContent="";var u=document.createElement("div");u.className="file-upload__spinner",l.appendChild(u),e.status="uploading";var p=new FormData;p.append("dumpfile",e.file),p.append("uploadbutton","1");var o=new XMLHttpRequest;o.upload.addEventListener("progress",function(c){if(c.lengthComputable){var f=Math.round(c.loaded/c.total*100);i.style.width=f+"%",v.textContent=f+"%",e.progress=f}}),o.addEventListener("load",function(){n.classList.remove("file-upload__item--uploading"),s.style.display="none",l.textContent="",o.status===200?(n.classList.add("file-upload__item--success"),l.appendChild(h("success")),e.status="success"):(n.classList.add("file-upload__item--error"),l.appendChild(h("error")),e.status="error"),r.uploading--,a(),b()}),o.addEventListener("error",function(){n.classList.remove("file-upload__item--uploading"),n.classList.add("file-upload__item--error"),s.style.display="none",l.textContent="",l.appendChild(h("error")),e.status="error",r.uploading--,a(),b()}),o.open("POST",d.uploadUrl),o.send(p),r.uploading++})}function b(){for(;r.uploading<d.maxConcurrent&&r.queue.length>0;){var t=r.queue.shift();O(t)}if(E(),r.uploading===0&&r.queue.length===0){var e=!1;r.files.forEach(function(a){a.status==="success"&&(e=!0)}),e&&setTimeout(function(){typeof refreshFileList=="function"?(q(),refreshFileList()):location.reload()},500)}}function G(){r.queue=[],r.files.forEach(function(t,e){t.status==="pending"&&r.queue.push(e)}),b()}function q(){r.files.clear(),r.queue=[],L.textContent="",E()}m.addEventListener("click",function(){B.click()}),B.addEventListener("change",function(t){S(t.target.files),B.value=""}),["dragenter","dragover"].forEach(function(t){m.addEventListener(t,function(e){e.preventDefault(),m.classList.add("file-upload__dropzone--active")})}),["dragleave","drop"].forEach(function(t){m.addEventListener(t,function(e){e.preventDefault(),m.classList.remove("file-upload__dropzone--active")})}),m.addEventListener("drop",function(t){var e=t.dataTransfer.files;S(e)}),L.addEventListener("click",function(t){var e=t.target.closest(".file-upload__item-remove");if(e){var a=e.dataset.id;P(a)}}),F.addEventListener("click",G),k.addEventListener("click",q),["dragenter","dragover","dragleave","drop"].forEach(function(t){window.addEventListener(t,function(e){e.preventDefault()})})})();
