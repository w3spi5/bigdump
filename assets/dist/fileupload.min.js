(function(){"use strict";var C=document.getElementById("fileUpload");if(!C)return;var f={maxFileSize:parseInt(C.dataset.maxFileSize,10)||0,maxConcurrent:2,allowedTypes:["sql","gz","csv"],uploadUrl:C.dataset.uploadUrl||""},r={files:new Map,uploading:0,queue:[]},m=document.getElementById("dropzone"),y=document.getElementById("fileInput"),x=document.getElementById("fileList"),M=document.getElementById("uploadActions"),B=document.getElementById("uploadBtn"),q=document.getElementById("clearBtn");function F(t){if(t===0)return"0 B";var e=1024,a=["B","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+a[n]}function z(t){return t.split(".").pop().toLowerCase()}function A(){return"file_"+Math.random().toString(36).substr(2,9)}function h(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("viewBox","0 0 24 24");var a=document.createElementNS("http://www.w3.org/2000/svg","path");return t==="success"?(e.setAttribute("fill","#38a169"),a.setAttribute("d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")):t==="error"?(e.setAttribute("fill","#e53e3e"),a.setAttribute("d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")):t==="remove"&&(a.setAttribute("d","M6 18L18 6M6 6l12 12"),a.setAttribute("stroke","currentColor"),a.setAttribute("stroke-width","2"),a.setAttribute("stroke-linecap","round")),e.appendChild(a),e}function S(t){var e=z(t.name);return f.allowedTypes.indexOf(e)===-1?{valid:!1,error:"Invalid file type. Allowed: "+f.allowedTypes.join(", ")}:t.size>f.maxFileSize?{valid:!1,error:"File too large. Max: "+F(f.maxFileSize)}:t.size===0?{valid:!1,error:"File is empty"}:{valid:!0}}function k(t,e,a){var n=z(e.name),s=a.valid,l=document.createElement("div");l.className="file-upload__item"+(s?"":" file-upload__item--error"),l.id=t;var v=document.createElement("div");v.className="file-upload__item-icon file-upload__item-icon--"+n,v.textContent=n,l.appendChild(v);var i=document.createElement("div");i.className="file-upload__item-info";var g=document.createElement("div");g.className="file-upload__item-name",g.textContent=e.name,i.appendChild(g);var d=document.createElement("div");if(d.className="file-upload__item-meta",d.textContent=F(e.size),!s){var u=document.createElement("span");u.className="file-upload__error",u.textContent=" \u2014 "+a.error,d.appendChild(u)}i.appendChild(d),l.appendChild(i);var o=document.createElement("div");o.className="file-upload__item-progress",o.style.display="none";var p=document.createElement("div");p.className="file-upload__progress-bar";var c=document.createElement("div");c.className="file-upload__progress-fill",c.style.width="0%",p.appendChild(c),o.appendChild(p);var w=document.createElement("div");w.className="file-upload__progress-text",w.textContent="0%",o.appendChild(w),l.appendChild(o);var b=document.createElement("div");b.className="file-upload__item-status",l.appendChild(b);var _=document.createElement("button");return _.type="button",_.className="file-upload__item-remove",_.dataset.id=t,_.appendChild(h("remove")),l.appendChild(_),l}function I(t){for(var e=0;e<t.length;e++){var a=t[e],n=A(),s=S(a);r.files.set(n,{file:a,status:s.valid?"pending":"invalid",progress:0,validation:s});var l=k(n,a,s);x.appendChild(l)}E()}function T(t){var e=document.getElementById(t);e&&e.remove(),r.files.delete(t),E()}function E(){var t=!1;r.files.forEach(function(e){e.status==="pending"&&(t=!0)}),M.style.display=r.files.size>0?"flex":"none",B.disabled=!t||r.uploading>0}function D(t){var e=r.files.get(t);return!e||e.status!=="pending"?Promise.resolve():new Promise(function(a){var n=document.getElementById(t),s=n.querySelector(".file-upload__item-progress"),l=n.querySelector(".file-upload__progress-fill"),v=n.querySelector(".file-upload__progress-text"),i=n.querySelector(".file-upload__item-status"),g=n.querySelector(".file-upload__item-remove");n.classList.add("file-upload__item--uploading"),s.style.display="block",g.style.display="none",i.textContent="";var d=document.createElement("div");d.className="file-upload__spinner",i.appendChild(d),e.status="uploading";var u=new FormData;u.append("dumpfile",e.file),u.append("uploadbutton","1");var o=new XMLHttpRequest;o.upload.addEventListener("progress",function(p){if(p.lengthComputable){var c=Math.round(p.loaded/p.total*100);l.style.width=c+"%",v.textContent=c+"%",e.progress=c}}),o.addEventListener("load",function(){n.classList.remove("file-upload__item--uploading"),s.style.display="none",i.textContent="",o.status===200?(n.classList.add("file-upload__item--success"),i.appendChild(h("success")),e.status="success"):(n.classList.add("file-upload__item--error"),i.appendChild(h("error")),e.status="error"),r.uploading--,a(),L()}),o.addEventListener("error",function(){n.classList.remove("file-upload__item--uploading"),n.classList.add("file-upload__item--error"),s.style.display="none",i.textContent="",i.appendChild(h("error")),e.status="error",r.uploading--,a(),L()}),o.open("POST",f.uploadUrl),o.send(u),r.uploading++})}function L(){for(;r.uploading<f.maxConcurrent&&r.queue.length>0;){var t=r.queue.shift();D(t)}if(E(),r.uploading===0&&r.queue.length===0){var e=!1;r.files.forEach(function(a){a.status==="success"&&(e=!0)}),e&&setTimeout(function(){typeof refreshFileList=="function"?(N(),refreshFileList()):location.reload()},500)}}function U(){r.queue=[],r.files.forEach(function(t,e){t.status==="pending"&&r.queue.push(e)}),L()}function N(){r.files.clear(),r.queue=[],x.textContent="",E()}m.addEventListener("click",function(){y.click()}),y.addEventListener("change",function(t){I(t.target.files),y.value=""}),["dragenter","dragover"].forEach(function(t){m.addEventListener(t,function(e){e.preventDefault(),m.classList.add("file-upload__dropzone--active")})}),["dragleave","drop"].forEach(function(t){m.addEventListener(t,function(e){e.preventDefault(),m.classList.remove("file-upload__dropzone--active")})}),m.addEventListener("drop",function(t){var e=t.dataTransfer.files;I(e)}),x.addEventListener("click",function(t){var e=t.target.closest(".file-upload__item-remove");if(e){var a=e.dataset.id;T(a)}}),B.addEventListener("click",U),q.addEventListener("click",N),["dragenter","dragover","dragleave","drop"].forEach(function(t){window.addEventListener(t,function(e){e.preventDefault()})})})();
